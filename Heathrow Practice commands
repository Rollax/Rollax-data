
Heath = LOAD '/data/heathrow.txt' USING PigStorage('\t') AS (year:chararray,month:int,maxtemp:float,mintemp:float,frostdays:int,rainfall:float,sunshine:chararray);

Data = FILTER Heath BY maxtemp IS NOT NULL AND mintemp IS NOT NULL AND year != 'yyyy';

Datavals = FOREACH Data GENERATE year,month,maxtemp,mintemp,frostdays,rainfall,REPLACE(sunshine,'---','') AS sunshine;

Datavals1 = FOREACH Datavals GENERATE year,month,maxtemp,mintemp,frostdays,rainfall,REPLACE(sunshine,'#','') AS sunshine;

Datavals2 = FOREACH Datavals1 GENERATE year,month,maxtemp,mintemp,frostdays,rainfall,REPLACE(sunshine,'Provisional','') AS sunshine;

Datavals3 = FOREACH Datavals2 GENERATE year,month,maxtemp,mintemp,frostdays,rainfall,REPLACE(sunshine,' ','') AS sunshine;

SortReadings = ORDER Datavals3 BY year ASC,month ASC;

STORE SortReadings INTO '/data/heathrowclean' USING PigStorage(' ');


# Python code for temp conversion in pig

@outputSchema("f_readings: {(year:chararray, month:int, maxtemp:float, mintemp:float, frostdays:int, rainfall:float, sunshine:chararray)}")
def fahrenheit(c_reading):
	year, month, maxtemp, mintemp, frostdays, rainfall, sunshine = c_reading.split(' ')
	maxtemp_f = float(maxtemp) * 9/5 + 32
	mintemp_f = float(mintemp) * 9/5 +32
	return year, int(month), maxtemp_f, mintemp_f, frostdays, float(rainfall), sunshine




# UDF in Pig

REGISTER 'hdfs:///data/weather_far_to_cel.py' USING jython as convert_temp;

Source = LOAD '/data/heathrowclean' AS (celsius_readings:chararray);

ConvertedReadings =  FOREACH Source GENERATE FLATTEN(convert_temp.fahrenheit(celsius_readings));

DUMP ConvertedReadings;

STORE ConvertedReadings INTO '/data/weatherdone1';

#----------------------------------------------------------------------------------------------------------------------------------
# Pyhton code for mm_inches conversion in hive

import sys
import string

while True:
	line=sys.stdin.readline()
	if not line:
		break
	row=string.strip(line, "\n")
	year,month,maxtemp,mintemp,frostday,rainfall,sunshine= string.split(row, "\t")
	rainfall= float(rainfall)/25.4
	print "\t".join([year,month,maxtemp,mintemp,frostday,str(rainfall),sunshine])



#Create Hive Table(degreee)

Drop table if exists degree;

create external table degree(
year float,
month float,
maxtemp float,
mintemp float,
frostday float,
rainfall float,
sunshine float)
row format delimited fields terminated by ' '
Stored as textfile location '/data/heathrowclean'; 


add file hdfs:///practice/mm_inches_him.py;

SELECT TRANSFORM(year,month,maxtemp,mintemp,frostday,rainfall,sunshine) USING 'python mm_inches_him.py' AS (year float,month float,maxtemp float,mintemp float,frostday float,rainfall float,sunshine float) FROM degree;

#-----------------------------------------------------------------------------------------------------------------------------------------------------------

# traffic 
# Pig

Source = LOAD 'practice/traffic.csv' USING PigStorage(',') AS (year:int,cp:int,start:chararray,end:chararray,dist:float,cycle:float,bike:float,car:float,bus:float,van:float,truck:float);

Data = Filter Source by year is not null;

GroupData = GROUP Data by year;

SumData = FOREACH GroupData GENERATE group as year,SUM(Data.dist) as totaldist,SUM(Data.van) as totalvan,SUM(Data.truck) as totaltruck;

OrderData = ORDER SumData by year ASC;

STORE OrderData into '/practice/traffic1' using PigStorage(' ');

# python code

@outputSchema("readings: {(year:int,totaldist:float,totalvan:float,totaltruck:float)}")

def miles(km):
	year,totaldist,totalvan,totaltruck = km.split(' ')
	miles = float(totaldist) * 0.6
	return int(year),miles,float(totalvan),float(totaltruck)





REGISTER 'hdfs:///practice/miles.py' USING jython as convert_dist;

Source = LOAD '/practice/traffic1' AS (km:chararray);

ConvertedDist = FOREACH Source GENERATE FLATTEN(convert_dist.miles(km));

Store ConvertedDist into '/practice/traffic_miles' USING PigStorage(' ');


#---------------------------------------------------

import sys
import string

while True:
	line=sys.stdin.readline()
	if not line:
		break
	row=string.strip(line, "\n")
	year,month,totaldist,totaltvan,totaltruck=string.split(row, "\t")
	totalfrieght= totalvan + totaldist
	print "\t".join([year,totaldist,str(totalfrieght)])



drop table if exists frieght;

create external table frieght(year int,totaldist float,totalvan float,totaltruck float) row format delimited fields terminated by ' ' Stored as textfile location '/practice/traffic1';

add file hdfs:///practice/totalfrieght.py;

SELECT TRANSFORM (year,totaldist,totalvan,totaltruck) USING 'python totalfrieght.py' AS (year int,totaldist float,totalfrieght float) FROM frieght;



